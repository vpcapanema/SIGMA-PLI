# ARQUITETURA DE AUTENTICAÃ‡ÃƒO - SIGMA-PLI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            CAMADA DE APRESENTAÃ‡ÃƒO                        â”‚
â”‚                              (Templates HTML)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚ HTTP/HTTPS
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CAMADA DE API                               â”‚
â”‚                         (FastAPI - Endpoints)                            â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  router_auth_api.py                                                      â”‚
â”‚                                                                          â”‚
â”‚  POST   /api/v1/auth/login       â”€â”                                     â”‚
â”‚  POST   /api/v1/auth/logout      â”€â”¤                                     â”‚
â”‚  GET    /api/v1/auth/me          â”€â”¤â”€â–º ValidaÃ§Ã£o Pydantic               â”‚
â”‚  POST   /api/v1/auth/register    â”€â”¤   + Tratamento de erros            â”‚
â”‚  POST   /api/v1/auth/refresh     â”€â”˜                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CAMADA DE SERVIÃ‡OS                               â”‚
â”‚                      (LÃ³gica de NegÃ³cio)                                 â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  service_auth.py (Orquestrador Principal)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ â€¢ authenticate()      â”€â”€â–º Login completo                  â”‚          â”‚
â”‚  â”‚ â€¢ logout()            â”€â”€â–º Revogar sessÃ£o                  â”‚          â”‚
â”‚  â”‚ â€¢ get_current_user()  â”€â”€â–º Obter dados por token           â”‚          â”‚
â”‚  â”‚ â€¢ refresh_session()   â”€â”€â–º Renovar tokens                  â”‚          â”‚
â”‚  â”‚ â€¢ register_user()     â”€â”€â–º Criar nova conta                â”‚          â”‚
â”‚  â”‚ â€¢ hash_password()     â”€â”€â–º PBKDF2-SHA256 (100k iteraÃ§Ãµes)  â”‚          â”‚
â”‚  â”‚ â€¢ verify_password()   â”€â”€â–º Validar hash                    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                         â”‚          â”‚          â”‚                          â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚              â–¼                     â–¼                     â–¼               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ UserService     â”‚  â”‚ SessionService  â”‚  â”‚ AuditService    â”‚         â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚         â”‚
â”‚  â”‚ â€¢ get_user_*()  â”‚  â”‚ â€¢ create_*()    â”‚  â”‚ â€¢ log_attempt() â”‚         â”‚
â”‚  â”‚ â€¢ create_user() â”‚  â”‚ â€¢ get_session() â”‚  â”‚ â€¢ get_recent()  â”‚         â”‚
â”‚  â”‚ â€¢ update_login()â”‚  â”‚ â€¢ revoke_*()    â”‚  â”‚ â€¢ count_fails() â”‚         â”‚
â”‚  â”‚ â€¢ increment_*() â”‚  â”‚ â€¢ refresh_*()   â”‚  â”‚                 â”‚         â”‚
â”‚  â”‚ â€¢ lock_account()â”‚  â”‚ â€¢ cleanup_*()   â”‚  â”‚                 â”‚         â”‚
â”‚  â”‚ â€¢ verify_email()â”‚  â”‚                 â”‚  â”‚                 â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CAMADA DE DADOS                                  â”‚
â”‚                    (PostgreSQL via asyncpg)                              â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  database.py - get_postgres_connection()                                 â”‚
â”‚                                                                          â”‚
â”‚  Schema: usuarios                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚                                                               â”‚        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚        â”‚
â”‚  â”‚  â”‚   pessoa     â”‚     â”‚ conta_usuario    â”‚                  â”‚        â”‚
â”‚  â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚        â”‚
â”‚  â”‚  â”‚ pessoa_id PK â”‚â—„â”€â”€â”€â”€â”‚ pessoa_id FK     â”‚                  â”‚        â”‚
â”‚  â”‚  â”‚ nome_completoâ”‚     â”‚ conta_id PK      â”‚                  â”‚        â”‚
â”‚  â”‚  â”‚ email        â”‚     â”‚ username UNIQUE  â”‚                  â”‚        â”‚
â”‚  â”‚  â”‚ cpf          â”‚     â”‚ password_hash    â”‚                  â”‚        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ salt             â”‚                  â”‚        â”‚
â”‚  â”‚                       â”‚ email_verificado â”‚                  â”‚        â”‚
â”‚  â”‚                       â”‚ ativo            â”‚                  â”‚        â”‚
â”‚  â”‚                       â”‚ tentativas_falhasâ”‚                  â”‚        â”‚
â”‚  â”‚                       â”‚ bloqueado_ate    â”‚                  â”‚        â”‚
â”‚  â”‚                       â”‚ ultimo_login     â”‚                  â”‚        â”‚
â”‚  â”‚                       â”‚ ultimo_ip        â”‚                  â”‚        â”‚
â”‚  â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚        â”‚
â”‚  â”‚                                â”‚                             â”‚        â”‚
â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚        â”‚
â”‚  â”‚              â–¼                 â–¼                 â–¼           â”‚        â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚        â”‚
â”‚  â”‚   â”‚     sessao       â”‚ â”‚token_recup   â”‚ â”‚tentativa_login  â”‚â”‚        â”‚
â”‚  â”‚   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”‚        â”‚
â”‚  â”‚   â”‚ sessao_token PK  â”‚ â”‚ token_id PK  â”‚ â”‚ tentativa_id PK â”‚â”‚        â”‚
â”‚  â”‚   â”‚ refresh_token    â”‚ â”‚ conta_id FK  â”‚ â”‚ username        â”‚â”‚        â”‚
â”‚  â”‚   â”‚ conta_id FK      â”‚ â”‚ token        â”‚ â”‚ email           â”‚â”‚        â”‚
â”‚  â”‚   â”‚ expires_at       â”‚ â”‚ expires_at   â”‚ â”‚ ip_address      â”‚â”‚        â”‚
â”‚  â”‚   â”‚ revogado         â”‚ â”‚ usado        â”‚ â”‚ user_agent      â”‚â”‚        â”‚
â”‚  â”‚   â”‚ ip_address       â”‚ â”‚ tipo         â”‚ â”‚ sucesso         â”‚â”‚        â”‚
â”‚  â”‚   â”‚ user_agent       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ motivo_falha    â”‚â”‚        â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚ timestamp       â”‚â”‚        â”‚
â”‚  â”‚                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” FLUXO DE AUTENTICAÃ‡ÃƒO (LOGIN)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cliente  â”‚         â”‚   API   â”‚         â”‚  Service   â”‚         â”‚ Database â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                    â”‚                    â”‚                      â”‚
     â”‚ POST /auth/login   â”‚                    â”‚                      â”‚
     â”‚ {user, password}   â”‚                    â”‚                      â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚                      â”‚
     â”‚                    â”‚                    â”‚                      â”‚
     â”‚                    â”‚ authenticate()     â”‚                      â”‚
     â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚
     â”‚                    â”‚                    â”‚                      â”‚
     â”‚                    â”‚                    â”‚ get_user_by_id()     â”‚
     â”‚                    â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                    â”‚                    â”‚                      â”‚
     â”‚                    â”‚                    â”‚ user_data            â”‚
     â”‚                    â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                    â”‚                    â”‚                      â”‚
     â”‚                    â”‚                    â”‚ âœ… verify_password() â”‚
     â”‚                    â”‚                    â”‚                      â”‚
     â”‚                    â”‚                    â”‚ is_account_locked()  â”‚
     â”‚                    â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                    â”‚                    â”‚                      â”‚
     â”‚                    â”‚                    â”‚ false                â”‚
     â”‚                    â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                    â”‚                    â”‚                      â”‚
     â”‚                    â”‚                    â”‚ create_session()     â”‚
     â”‚                    â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                    â”‚                    â”‚                      â”‚
     â”‚                    â”‚                    â”‚ tokens               â”‚
     â”‚                    â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                    â”‚                    â”‚                      â”‚
     â”‚                    â”‚                    â”‚ update_last_login()  â”‚
     â”‚                    â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                    â”‚                    â”‚                      â”‚
     â”‚                    â”‚                    â”‚ log_login_attempt()  â”‚
     â”‚                    â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                    â”‚                    â”‚                      â”‚
     â”‚                    â”‚ user + tokens      â”‚                      â”‚
     â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
     â”‚                    â”‚                    â”‚                      â”‚
     â”‚ 200 OK             â”‚                    â”‚                      â”‚
     â”‚ {user, tokens}     â”‚                    â”‚                      â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                      â”‚
     â”‚                    â”‚                    â”‚                      â”‚
```

---

## ğŸ”’ FLUXO DE PROTEÃ‡ÃƒO (Brute Force)

```
Tentativa 1: âŒ Senha errada
  â””â”€â–º tentativas_falhas = 1

Tentativa 2: âŒ Senha errada
  â””â”€â–º tentativas_falhas = 2

Tentativa 3: âŒ Senha errada
  â””â”€â–º tentativas_falhas = 3

Tentativa 4: âŒ Senha errada
  â””â”€â–º tentativas_falhas = 4

Tentativa 5: âŒ Senha errada
  â””â”€â–º tentativas_falhas = 5
  â””â”€â–º ğŸ”’ CONTA BLOQUEADA (bloqueado_ate = now + 30 min)

Tentativa 6: â›” BLOQUEADO
  â””â”€â–º HTTP 401: "Conta temporariamente bloqueada"

... 30 minutos depois ...

Tentativa 7: âœ… Senha correta
  â””â”€â–º tentativas_falhas = 0
  â””â”€â–º bloqueado_ate = NULL
  â””â”€â–º ğŸ‰ LOGIN BEM-SUCEDIDO
```

---

## ğŸ”„ FLUXO DE REFRESH DE SESSÃƒO

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cliente  â”‚         â”‚   API   â”‚         â”‚  Service   â”‚         â”‚ Database â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                    â”‚                    â”‚                      â”‚
     â”‚ POST /auth/refresh â”‚                    â”‚                      â”‚
     â”‚ {refresh_token}    â”‚                    â”‚                      â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚                      â”‚
     â”‚                    â”‚                    â”‚                      â”‚
     â”‚                    â”‚ refresh_session()  â”‚                      â”‚
     â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚
     â”‚                    â”‚                    â”‚                      â”‚
     â”‚                    â”‚                    â”‚ get_session_by_      â”‚
     â”‚                    â”‚                    â”‚   refresh_token()    â”‚
     â”‚                    â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                    â”‚                    â”‚                      â”‚
     â”‚                    â”‚                    â”‚ old_session          â”‚
     â”‚                    â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                    â”‚                    â”‚                      â”‚
     â”‚                    â”‚                    â”‚ âœ… Validate expiry   â”‚
     â”‚                    â”‚                    â”‚                      â”‚
     â”‚                    â”‚                    â”‚ revoke_session()     â”‚
     â”‚                    â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                    â”‚                    â”‚                      â”‚
     â”‚                    â”‚                    â”‚ create_session()     â”‚
     â”‚                    â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                    â”‚                    â”‚                      â”‚
     â”‚                    â”‚                    â”‚ new_tokens           â”‚
     â”‚                    â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                    â”‚                    â”‚                      â”‚
     â”‚                    â”‚ new_tokens         â”‚                      â”‚
     â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
     â”‚                    â”‚                    â”‚                      â”‚
     â”‚ 200 OK             â”‚                    â”‚                      â”‚
     â”‚ {new_tokens}       â”‚                    â”‚                      â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                      â”‚
     â”‚                    â”‚                    â”‚                      â”‚
```

---

## ğŸ“Š ESTATÃSTICAS DE IMPLEMENTAÃ‡ÃƒO

| Componente       | Arquivos | Linhas | MÃ©todos/Endpoints |
| ---------------- | -------- | ------ | ----------------- |
| **ServiÃ§os**     | 4        | 1.007  | 32 mÃ©todos        |
| **Routers**      | 1        | 210    | 5 endpoints       |
| **Schemas**      | -        | -      | 6 modelos         |
| **Testes**       | 1        | 190    | 7 casos           |
| **DocumentaÃ§Ã£o** | 2        | 500+   | -                 |
| **TOTAL**        | 8        | 1.907  | 43 componentes    |

---

## ğŸ¯ COBERTURA DE FUNCIONALIDADES

| Funcionalidade      | Status | Arquivo                    |
| ------------------- | ------ | -------------------------- |
| Registro de usuÃ¡rio | âœ…     | service_auth.py            |
| Login               | âœ…     | service_auth.py            |
| Logout              | âœ…     | service_auth_session.py    |
| Refresh de sessÃ£o   | âœ…     | service_auth_session.py    |
| Verificar sessÃ£o    | âœ…     | service_auth.py            |
| Hash de senha       | âœ…     | service_auth.py (PBKDF2)   |
| Bloqueio anti-brute | âœ…     | service_auth_user.py       |
| Auditoria de login  | âœ…     | service_auth_audit.py      |
| MÃºltiplas sessÃµes   | âœ…     | service_auth_session.py    |
| Logout global       | âœ…     | revoke_all_user_sessions() |
| Limpeza de sessÃµes  | âœ…     | cleanup_expired_sessions() |
| ValidaÃ§Ã£o de email  | âœ…     | verify_email()             |
| AlteraÃ§Ã£o de senha  | âœ…     | update_password()          |

---

## ğŸ“ CHECKLIST DE SEGURANÃ‡A

- [x] Hash de senha com PBKDF2-SHA256
- [x] Salt Ãºnico por usuÃ¡rio (16 bytes)
- [x] 100.000 iteraÃ§Ãµes (OWASP recommended)
- [x] Tokens seguros (secrets.token_urlsafe)
- [x] ProteÃ§Ã£o contra brute force (5 tentativas = 30min)
- [x] ExpiraÃ§Ã£o de sessÃ£o (24h)
- [x] Refresh token separado
- [x] RevogaÃ§Ã£o de sessÃ£o (logout)
- [x] Rastreamento de IP
- [x] Rastreamento de User-Agent
- [x] Auditoria completa de tentativas
- [x] ValidaÃ§Ã£o de entrada (Pydantic)
- [x] Tratamento de erros HTTP apropriado
- [ ] Rate limiting por IP (pendente)
- [ ] CAPTCHA apÃ³s X tentativas (pendente)
- [ ] 2FA/TOTP (estrutura pronta, pendente)
- [ ] NotificaÃ§Ã£o de novo dispositivo (pendente)

---

**Data:** $(Get-Date -Format "dd/MM/yyyy HH:mm")
**Status:** IMPLEMENTAÃ‡ÃƒO COMPLETA âœ…
