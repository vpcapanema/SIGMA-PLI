version: '3.8'

services:

  geoserver:
    image: docker.osgeo.org/geoserver:2.27.2
    environment:
      - GEOSERVER_ADMIN_USER=admin
      - GEOSERVER_ADMIN_PASSWORD=geoserver
      - INITIAL_MEMORY=2G
      - MAXIMUM_MEMORY=4G
    volumes:
      - geoserver_data:/opt/geoserver/data_dir
    ports:
      - "8080:8080"
    networks:
      - sigma_network
    depends_on:
      - db

  neo4j:
    image: neo4j:5
    environment:
      - NEO4J_AUTH=neo4j/sigma_pass
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_memory_heap_initial__size=1G
      - NEO4J_dbms_memory_heap_max__size=2G
      - NEO4J_dbms_memory_pagecache_size=1G
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    volumes:
      - neo4j_data:/data
      - ./neo4j/init.cypher:/init.cypher
    command: >
      bash -c "
        neo4j-admin dbms set-initial-password sigma_pass || true
        neo4j start &&
        sleep 10 &&
        cat /init.cypher | cypher-shell -u neo4j -p sigma_pass &&
        tail -f /dev/null
      "
    networks:
      - sigma_network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    volumes:
      - ./backend:/app
    ports:
      - "8000:8000"
    environment:
      - POSTGRES_HOST=sigma-pli-postgresql-db.cwlmgwc4igdh.us-east-1.rds.amazonaws.com
      - POSTGRES_PORT=5432
      - POSTGRES_DB=sigma_pli
      - POSTGRES_USER=sigma_admin
      - POSTGRES_PASSWORD=Malditas131533*
      - POSTGRES_SSLMODE=require
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=sigma_pass
    networks:
      - sigma_network
    depends_on:
      - neo4j

  apache:
    image: httpd:2.4
    ports:
      - "80:80"
    volumes:
      - ./frontend:/usr/local/apache2/htdocs/
      - ./apache/conf:/usr/local/apache2/conf
    networks:
      - sigma_network
    depends_on:
      - backend
      - geoserver

networks:
  sigma_network:
    driver: bridge

volumes:
  postgres_data:
  geoserver_data:
  neo4j_data:
