{% extends 'pages/M01_auth/template_base_auth.html' %}

{% block title %}Gestão de Usuários | SIGMA-PLI{% endblock %}

{% block extra_head %}
<style>
  .metric-card {
    border-radius: 12px;
    border: 1px solid rgba(77, 166, 255, 0.3);
    background: rgba(22, 42, 72, 0.9);
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  .metric-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 24px rgba(77, 166, 255, 0.2);
    border-color: rgba(77, 166, 255, 0.6);
  }
  .metric-card h6 {
    color: #8b98a5;
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }
  .metric-card h3 {
    color: #4da6ff;
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
  }
  .metric-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.2;
  }
  .metric-icon i {
    font-size: 1.8rem;
    color: white;
  }
  .bg-primary { background: linear-gradient(135deg, #4da6ff, #0066cc); }
  .bg-success { background: linear-gradient(135deg, #28a745, #1e7e34); }
  .bg-warning { background: linear-gradient(135deg, #ffc107, #e0a800); }
  .bg-danger { background: linear-gradient(135deg, #dc3545, #c82333); }
  
  .card {
    background: rgba(22, 42, 72, 0.9);
    border: 1px solid rgba(77, 166, 255, 0.3);
    border-radius: 12px;
  }
  .card-header {
    background: rgba(77, 166, 255, 0.1);
    border-bottom: 1px solid rgba(77, 166, 255, 0.3);
    color: #4da6ff;
    font-weight: 600;
  }
  .table {
    color: #e0e6ed;
  }
  .table thead th {
    background: rgba(77, 166, 255, 0.1);
    border-color: rgba(77, 166, 255, 0.3);
    color: #4da6ff;
  }
  .table tbody tr:hover {
    background: rgba(77, 166, 255, 0.05);
  }
  .modal-content {
    background: linear-gradient(135deg, #0b1729 0%, #162a48 100%);
    border: 1px solid rgba(77, 166, 255, 0.3);
  }
  .modal-header {
    border-bottom: 1px solid rgba(77, 166, 255, 0.3);
  }
  .modal-footer {
    border-top: 1px solid rgba(77, 166, 255, 0.3);
  }
  .section-divider {
    border-top: 2px solid rgba(77, 166, 255, 0.3);
    margin: 1.5rem 0;
    padding-top: 1rem;
  }
  .section-title {
    color: #4da6ff;
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .password-strength {
    height: 4px;
    background: #2c3e50;
    border-radius: 2px;
    margin-top: 5px;
    overflow: hidden;
  }
  .password-strength-bar {
    height: 100%;
    transition: all 0.3s;
    border-radius: 2px;
  }
  .avatar-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4da6ff, #0066cc);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: 700;
    color: white;
    margin: 0 auto;
  }
</style>
{% endblock %}

{% block content %}
<div class="pli-main-content">
  <main class="container-fluid py-4">
    <!-- Cabeçalho -->
    <div class="row mb-4">
      <div class="col-12 d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-1">
            <i class="fas fa-users-cog text-primary"></i>
            Gestão de Usuários do Sistema
          </h1>
          <p class="text-muted mb-0">Gerencie usuários, permissões e acessos ao SIGMA-PLI</p>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-success" id="btnExportar">
            <i class="fas fa-file-excel me-2"></i>Exportar
          </button>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#usuarioModal" id="btnNovoUsuario">
            <i class="fas fa-user-plus me-2"></i>Novo Usuário
          </button>
        </div>
      </div>
    </div>

    <!-- Métricas -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card metric-card border-primary">
          <div class="card-body">
            <h6>Total de Usuários</h6>
            <h3 id="totalUsuarios">-</h3>
            <div class="metric-icon bg-primary">
              <i class="fas fa-users"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card metric-card border-success">
          <div class="card-body">
            <h6>Usuários Ativos</h6>
            <h3 id="usuariosAtivos">-</h3>
            <div class="metric-icon bg-success">
              <i class="fas fa-user-check"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card metric-card border-warning">
          <div class="card-body">
            <h6>Bloqueados</h6>
            <h3 id="usuariosBloqueados">-</h3>
            <div class="metric-icon bg-warning">
              <i class="fas fa-user-lock"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card metric-card border-danger">
          <div class="card-body">
            <h6>Online Agora</h6>
            <h3 id="usuariosOnline">-</h3>
            <div class="metric-icon bg-danger">
              <i class="fas fa-circle"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtros Avançados -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-filter"></i> Filtros de Busca</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label" for="filtroNome">Nome</label>
                <input class="form-control" id="filtroNome" placeholder="Buscar por nome" type="text">
              </div>
              <div class="col-md-3">
                <label class="form-label" for="filtroEmail">E-mail</label>
                <input class="form-control" id="filtroEmail" placeholder="usuario@exemplo.com" type="email">
              </div>
              <div class="col-md-2">
                <label class="form-label" for="filtroPerfil">Perfil</label>
                <select class="form-select" id="filtroPerfil">
                  <option value="">Todos</option>
                  <option value="ADMIN">Administrador</option>
                  <option value="GESTOR">Gestor</option>
                  <option value="USUARIO">Usuário</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label" for="filtroStatus">Status</label>
                <select class="form-select" id="filtroStatus">
                  <option value="">Todos</option>
                  <option value="ativo">Ativo</option>
                  <option value="bloqueado">Bloqueado</option>
                  <option value="inativo">Inativo</option>
                </select>
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <div class="w-100">
                  <button class="btn btn-primary w-100" id="btnBuscar">
                    <i class="fas fa-search me-2"></i>Buscar
                  </button>
                </div>
              </div>
              <div class="col-md-12">
                <button class="btn btn-secondary btn-sm" id="btnLimpar">
                  <i class="fas fa-times me-2"></i>Limpar Filtros
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabela -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-table"></i> Lista de Usuários</h5>
            <div class="d-flex gap-2 align-items-center">
              <input type="checkbox" id="selectAll" class="form-check-input">
              <label for="selectAll" class="form-check-label me-3">Selecionar Todos</label>
              <span class="text-muted" id="totalRegistros">0 registros</span>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover" id="usuariosTable">
                <thead>
                  <tr>
                    <th width="50"><input type="checkbox" class="form-check-input" id="selectAllHeader" title="Selecionar todos"></th>
                    <th>Nome</th>
                    <th>CPF</th>
                    <th>E-mail</th>
                    <th>Telefone</th>
                    <th>Perfil</th>
                    <th>Cargo</th>
                    <th>Status</th>
                    <th width="150">Ações</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="9" class="text-center text-muted">
                      <i class="fas fa-spinner fa-spin me-2"></i>Carregando dados...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <!-- Paginação -->
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div class="text-muted">
                Mostrando <span id="showingStart">0</span> a <span id="showingEnd">0</span> de <span id="showingTotal">0</span> registros
              </div>
              <nav>
                <ul class="pagination mb-0" id="pagination"></ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- Modal Cadastro/Edição COMPLETO -->
<div class="modal fade" id="usuarioModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-user-plus me-2 text-primary"></i>
          <span id="modalTitle">Novo Usuário</span>
        </h5>
        <button class="btn-close" data-bs-dismiss="modal" aria-label="Fechar" type="button"></button>
      </div>
      <form id="usuarioForm" novalidate>
        <input type="hidden" id="usuarioId" name="id">
        <div class="modal-body">
          
          <!-- Avatar Preview -->
          <div class="row mb-4">
            <div class="col-12 text-center">
              <div class="avatar-circle" id="avatarPreview">U</div>
              <p class="text-muted mt-2 small">Avatar gerado automaticamente com a primeira letra do nome</p>
            </div>
          </div>

          <!-- SEÇÃO 1: Dados Pessoais -->
          <div class="section-title">
            <i class="fas fa-user"></i>
            Dados Pessoais
          </div>
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label class="form-label" for="nome">Nome Completo *</label>
              <input class="form-control" id="nome" name="nome" required type="text">
              <div class="invalid-feedback">Nome completo é obrigatório</div>
            </div>
            <div class="col-md-3">
              <label class="form-label" for="cpf">CPF *</label>
              <input class="form-control" id="cpf" name="cpf" placeholder="000.000.000-00" required type="text" maxlength="14">
              <div class="invalid-feedback">CPF válido é obrigatório</div>
            </div>
            <div class="col-md-3">
              <label class="form-label" for="dataNascimento">Data de Nascimento</label>
              <input class="form-control" id="dataNascimento" name="dataNascimento" type="date">
            </div>
          </div>

          <!-- SEÇÃO 2: Contato -->
          <div class="section-divider"></div>
          <div class="section-title">
            <i class="fas fa-phone"></i>
            Informações de Contato
          </div>
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label" for="email">E-mail *</label>
              <input class="form-control" id="email" name="email" placeholder="usuario@exemplo.com" required type="email">
              <div class="invalid-feedback">E-mail válido é obrigatório</div>
            </div>
            <div class="col-md-4">
              <label class="form-label" for="telefone">Telefone</label>
              <input class="form-control" id="telefone" name="telefone" placeholder="(00) 0000-0000" type="tel">
            </div>
            <div class="col-md-4">
              <label class="form-label" for="celular">Celular *</label>
              <input class="form-control" id="celular" name="celular" placeholder="(00) 00000-0000" required type="tel">
              <div class="invalid-feedback">Celular é obrigatório</div>
            </div>
          </div>

          <!-- SEÇÃO 3: Dados Profissionais -->
          <div class="section-divider"></div>
          <div class="section-title">
            <i class="fas fa-briefcase"></i>
            Dados Profissionais
          </div>
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label" for="cargo">Cargo *</label>
              <input class="form-control" id="cargo" name="cargo" required type="text">
              <div class="invalid-feedback">Cargo é obrigatório</div>
            </div>
            <div class="col-md-4">
              <label class="form-label" for="departamento">Departamento *</label>
              <select class="form-select" id="departamento" name="departamento" required>
                <option value="">Selecione</option>
                <option value="TI">Tecnologia da Informação</option>
                <option value="RH">Recursos Humanos</option>
                <option value="FINANCEIRO">Financeiro</option>
                <option value="COMERCIAL">Comercial</option>
                <option value="OPERACIONAL">Operacional</option>
                <option value="JURIDICO">Jurídico</option>
              </select>
              <div class="invalid-feedback">Departamento é obrigatório</div>
            </div>
            <div class="col-md-4">
              <label class="form-label" for="dataAdmissao">Data de Admissão *</label>
              <input class="form-control" id="dataAdmissao" name="dataAdmissao" required type="date">
              <div class="invalid-feedback">Data de admissão é obrigatória</div>
            </div>
          </div>
          <div class="row g-3 mt-2">
            <div class="col-md-6">
              <label class="form-label" for="matricula">Matrícula</label>
              <input class="form-control" id="matricula" name="matricula" type="text">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="setor">Setor/Lotação</label>
              <input class="form-control" id="setor" name="setor" type="text">
            </div>
          </div>

          <!-- SEÇÃO 4: Acesso ao Sistema -->
          <div class="section-divider"></div>
          <div class="section-title">
            <i class="fas fa-shield-alt"></i>
            Configurações de Acesso
          </div>
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label" for="perfil">Perfil de Acesso *</label>
              <select class="form-select" id="perfil" name="perfil" required>
                <option value="">Selecione</option>
                <option value="USUARIO">Usuário - Acesso básico</option>
                <option value="GESTOR">Gestor - Acesso intermediário</option>
                <option value="ADMIN">Administrador - Acesso total</option>
              </select>
              <div class="invalid-feedback">Perfil é obrigatório</div>
            </div>
            <div class="col-md-4">
              <label class="form-label" for="status">Status *</label>
              <select class="form-select" id="status" name="status" required>
                <option value="ativo">Ativo</option>
                <option value="bloqueado">Bloqueado</option>
                <option value="inativo">Inativo</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Configurações</label>
              <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" id="exigirTrocaSenha" name="exigirTrocaSenha">
                <label class="form-check-label" for="exigirTrocaSenha">
                  Exigir troca de senha no próximo login
                </label>
              </div>
              <div class="form-check mt-1">
                <input class="form-check-input" type="checkbox" id="notificacoesEmail" name="notificacoesEmail" checked>
                <label class="form-check-label" for="notificacoesEmail">
                  Receber notificações por e-mail
                </label>
              </div>
            </div>
          </div>

          <!-- SEÇÃO 5: Senha (apenas para novo usuário) -->
          <div class="section-divider" id="secaoSenha"></div>
          <div class="section-title" id="secaoSenhaTitle">
            <i class="fas fa-key"></i>
            Definir Senha de Acesso
          </div>
          <div class="row g-3" id="secaoSenhaFields">
            <div class="col-md-6">
              <label class="form-label" for="senha">Senha *</label>
              <input class="form-control" id="senha" name="senha" type="password" autocomplete="new-password">
              <div class="password-strength">
                <div class="password-strength-bar" id="passwordStrengthBar"></div>
              </div>
              <div class="form-text">Mínimo 8 caracteres, incluindo maiúscula, minúscula, número e caractere especial</div>
              <div class="invalid-feedback">Senha é obrigatória</div>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="confirmarSenha">Confirmar Senha *</label>
              <input class="form-control" id="confirmarSenha" name="confirmarSenha" type="password" autocomplete="new-password">
              <div class="invalid-feedback">As senhas devem ser iguais</div>
            </div>
          </div>

          <!-- Observações -->
          <div class="section-divider"></div>
          <div class="row">
            <div class="col-12">
              <label class="form-label" for="observacoes">Observações</label>
              <textarea class="form-control" id="observacoes" name="observacoes" rows="3"></textarea>
            </div>
          </div>

        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">
            <i class="fas fa-times me-2"></i>Cancelar
          </button>
          <button class="btn btn-primary" type="submit">
            <i class="fas fa-save me-2"></i>Salvar Usuário
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Dados mockados
const usuariosMock = [
  {
    id: 1,
    nome: 'João Silva Santos',
    cpf: '123.456.789-00',
    email: 'joao.silva@sigma.gov.br',
    telefone: '(11) 3456-7890',
    celular: '(11) 98765-4321',
    cargo: 'Analista de Sistemas',
    departamento: 'TI',
    perfil: 'ADMIN',
    status: 'ativo'
  },
  {
    id: 2,
    nome: 'Maria Oliveira Costa',
    cpf: '987.654.321-00',
    email: 'maria.oliveira@sigma.gov.br',
    celular: '(21) 99876-5432',
    cargo: 'Gestora de RH',
    departamento: 'RH',
    perfil: 'GESTOR',
    status: 'ativo'
  },
  {
    id: 3,
    nome: 'Pedro Souza Lima',
    cpf: '456.789.123-00',
    email: 'pedro.souza@sigma.gov.br',
    celular: '(31) 97654-3210',
    cargo: 'Auxiliar Administrativo',
    departamento: 'FINANCEIRO',
    perfil: 'USUARIO',
    status: 'bloqueado'
  }
];

// Carregar métricas
function carregarMetricas() {
  document.getElementById('totalUsuarios').textContent = usuariosMock.length;
  document.getElementById('usuariosAtivos').textContent = usuariosMock.filter(u => u.status === 'ativo').length;
  document.getElementById('usuariosBloqueados').textContent = usuariosMock.filter(u => u.status === 'bloqueado').length;
  document.getElementById('usuariosOnline').textContent = '2';
}

// Carregar tabela
function carregarTabela(dados = usuariosMock) {
  const tbody = document.querySelector('#usuariosTable tbody');
  
  if (dados.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Nenhum usuário encontrado</td></tr>';
    return;
  }
  
  tbody.innerHTML = dados.map(user => `
    <tr>
      <td><input type="checkbox" class="form-check-input row-select" data-id="${user.id}"></td>
      <td>${user.nome}</td>
      <td>${user.cpf}</td>
      <td>${user.email}</td>
      <td>${user.celular}</td>
      <td>
        <span class="badge bg-${user.perfil === 'ADMIN' ? 'danger' : user.perfil === 'GESTOR' ? 'warning' : 'info'}">
          ${user.perfil === 'ADMIN' ? 'Administrador' : user.perfil === 'GESTOR' ? 'Gestor' : 'Usuário'}
        </span>
      </td>
      <td>${user.cargo}</td>
      <td>
        <span class="badge bg-${user.status === 'ativo' ? 'success' : user.status === 'bloqueado' ? 'danger' : 'secondary'}">
          ${user.status === 'ativo' ? 'Ativo' : user.status === 'bloqueado' ? 'Bloqueado' : 'Inativo'}
        </span>
      </td>
      <td>
        <button class="btn btn-sm btn-primary" onclick="editarUsuario(${user.id})" title="Editar">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-sm btn-danger" onclick="excluirUsuario(${user.id})" title="Excluir">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    </tr>
  `).join('');
  
  document.getElementById('totalRegistros').textContent = `${dados.length} registro${dados.length !== 1 ? 's' : ''}`;
}

// Editar usuário
function editarUsuario(id) {
  const usuario = usuariosMock.find(u => u.id === id);
  if (!usuario) return;
  
  document.getElementById('modalTitle').textContent = 'Editar Usuário';
  document.getElementById('usuarioId').value = usuario.id;
  
  // Preencher campos
  Object.keys(usuario).forEach(key => {
    const field = document.getElementById(key);
    if (field) field.value = usuario[key] || '';
  });
  
  // Ocultar seção de senha ao editar
  document.getElementById('secaoSenha').style.display = 'none';
  document.getElementById('secaoSenhaTitle').style.display = 'none';
  document.getElementById('secaoSenhaFields').style.display = 'none';
  document.getElementById('senha').removeAttribute('required');
  document.getElementById('confirmarSenha').removeAttribute('required');
  
  // Atualizar avatar
  document.getElementById('avatarPreview').textContent = usuario.nome.charAt(0).toUpperCase();
  
  new bootstrap.Modal(document.getElementById('usuarioModal')).show();
}

// Excluir usuário
function excluirUsuario(id) {
  if (confirm('Tem certeza que deseja excluir este usuário?')) {
    alert('Usuário excluído com sucesso!');
    carregarTabela();
  }
}

// Atualizar avatar ao digitar nome
document.getElementById('nome')?.addEventListener('input', function(e) {
  const letra = e.target.value.charAt(0).toUpperCase() || 'U';
  document.getElementById('avatarPreview').textContent = letra;
});

// Força da senha
document.getElementById('senha')?.addEventListener('input', function(e) {
  const senha = e.target.value;
  let forca = 0;
  
  if (senha.length >= 8) forca++;
  if (/[a-z]/.test(senha)) forca++;
  if (/[A-Z]/.test(senha)) forca++;
  if (/[0-9]/.test(senha)) forca++;
  if (/[^a-zA-Z0-9]/.test(senha)) forca++;
  
  const bar = document.getElementById('passwordStrengthBar');
  const cores = ['#dc3545', '#ffc107', '#17a2b8', '#28a745'];
  const larguras = ['20%', '40%', '70%', '100%'];
  
  if (forca > 0) {
    bar.style.width = larguras[forca - 1];
    bar.style.background = cores[forca - 1];
  } else {
    bar.style.width = '0';
  }
});

// Form submit
document.getElementById('usuarioForm')?.addEventListener('submit', function(e) {
  e.preventDefault();
  
  // Validar senhas
  const senha = document.getElementById('senha').value;
  const confirmar = document.getElementById('confirmarSenha').value;
  const isEdicao = document.getElementById('usuarioId').value !== '';
  
  if (!isEdicao && senha !== confirmar) {
    document.getElementById('confirmarSenha').setCustomValidity('As senhas não coincidem');
  } else {
    document.getElementById('confirmarSenha').setCustomValidity('');
  }
  
  if (!this.checkValidity()) {
    e.stopPropagation();
    this.classList.add('was-validated');
    return;
  }
  
  alert('Usuário salvo com sucesso!');
  bootstrap.Modal.getInstance(document.getElementById('usuarioModal')).hide();
  this.reset();
  this.classList.remove('was-validated');
  carregarTabela();
});

// Limpar modal ao fechar
document.getElementById('usuarioModal')?.addEventListener('hidden.bs.modal', function() {
  const form = document.getElementById('usuarioForm');
  form.reset();
  form.classList.remove('was-validated');
  document.getElementById('modalTitle').textContent = 'Novo Usuário';
  document.getElementById('usuarioId').value = '';
  document.getElementById('avatarPreview').textContent = 'U';
  
  // Restaurar seção senha
  document.getElementById('secaoSenha').style.display = 'block';
  document.getElementById('secaoSenhaTitle').style.display = 'flex';
  document.getElementById('secaoSenhaFields').style.display = 'flex';
  document.getElementById('senha').setAttribute('required', '');
  document.getElementById('confirmarSenha').setAttribute('required', '');
  document.getElementById('passwordStrengthBar').style.width = '0';
});

// Buscar
document.getElementById('btnBuscar')?.addEventListener('click', function() {
  const nome = document.getElementById('filtroNome').value.toLowerCase();
  const email = document.getElementById('filtroEmail').value.toLowerCase();
  const perfil = document.getElementById('filtroPerfil').value;
  const status = document.getElementById('filtroStatus').value;
  
  const filtrados = usuariosMock.filter(user => {
    return (!nome || user.nome.toLowerCase().includes(nome)) &&
           (!email || user.email.toLowerCase().includes(email)) &&
           (!perfil || user.perfil === perfil) &&
           (!status || user.status === status);
  });
  
  carregarTabela(filtrados);
});

// Limpar
document.getElementById('btnLimpar')?.addEventListener('click', function() {
  document.getElementById('filtroNome').value = '';
  document.getElementById('filtroEmail').value = '';
  document.getElementById('filtroPerfil').value = '';
  document.getElementById('filtroStatus').value = '';
  carregarTabela();
});

// Exportar
document.getElementById('btnExportar')?.addEventListener('click', function() {
  alert('Exportando usuários para Excel...');
});

// Máscara CPF
document.getElementById('cpf')?.addEventListener('input', function(e) {
  let value = e.target.value.replace(/\D/g, '');
  value = value.replace(/(\d{3})(\d)/, '$1.$2');
  value = value.replace(/(\d{3})(\d)/, '$1.$2');
  value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
  e.target.value = value;
});

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
  carregarMetricas();
  carregarTabela();
});
</script>
{% endblock %}
