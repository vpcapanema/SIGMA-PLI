<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mapeamento - Cadastro Pessoa</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container {
            padding: 20px;
        }

        .table-container {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Mapeamento: Form Fields → cadastro.pessoa</h1>
        <p>Esta tela exibe as colunas do banco (cadastro.pessoa) e os campos do formulário (payload).</p>
        <div class="row">
            <div class="col-md-6 table-container">
                <h4>Colunas no banco (cadastro.pessoa)</h4>
                <table id="dbColumnsTable" class="table table-striped table-bordered table-sm">
                    <thead>
                        <tr>
                            <th>Coluna</th>
                            <th>Tipo</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="col-md-6 table-container">
                <h4>Campos do formulário (payload)</h4>
                <table id="formFieldsTable" class="table table-striped table-bordered table-sm">
                    <thead>
                        <tr>
                            <th>Campo</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div>
            <h5>Observações</h5>
            <ul id="observations"></ul>
        </div>
    </div>
    <script>
        async function loadJSON(path) {
            const res = await fetch(path);
            if (!res.ok) throw new Error('Falha ao carregar ' + path)
            return await res.json();
        }
        function renderDBColumns(cols) {
            const tbody = document.querySelector('#dbColumnsTable tbody');
            tbody.innerHTML = '';
            cols.forEach(c => {
                const tr = document.createElement('tr');
                const td1 = document.createElement('td'); td1.textContent = c.column_name;
                const td2 = document.createElement('td'); td2.textContent = c.data_type;
                tr.appendChild(td1); tr.appendChild(td2);
                tbody.appendChild(tr);
            })
        }
        function renderFormFields(fields) {
            const tbody = document.querySelector('#formFieldsTable tbody');
            tbody.innerHTML = '';
            fields.forEach(f => {
                const tr = document.createElement('tr');
                const td = document.createElement('td'); td.textContent = f;
                tr.appendChild(td);
                tbody.appendChild(tr);
            })
        }
        function diffAndNotes(cols, fields) {
            const colNames = new Set(cols.map(c => c.column_name));
            const fieldSet = new Set(fields);
            const notesEl = document.getElementById('observations');
            notesEl.innerHTML = '';
            // fields not in DB
            const missing = fields.filter(f => !colNames.has(f));
            if (missing.length) {
                const li = document.createElement('li');
                li.innerHTML = '<strong>Campos enviados que não existem em cadastro.pessoa:</strong> ' + missing.join(', ');
                notesEl.appendChild(li);
            }
            // db cols not in form
            const missingForm = cols.map(c => c.column_name).filter(cn => !fieldSet.has(cn));
            if (missingForm.length) {
                const li = document.createElement('li');
                li.innerHTML = '<strong>Colunas do DB não enviadas pelo payload:</strong> ' + missingForm.join(', ');
                notesEl.appendChild(li);
            }
        }
        async function init() {
            try {
                const cols = await loadJSON('/static/data/schema_cadastro_pessoa.json');
                const fields = await loadJSON('/static/data/form_fields_cadastro_pessoa.json');
                renderDBColumns(cols);
                renderFormFields(fields);
                diffAndNotes(cols, fields);
            } catch (err) {
                console.error(err);
                document.querySelector('.container').insertAdjacentHTML('beforeend', '<div class="alert alert-danger mt-3">Erro ao carregar dados: ' + err.message + '</div>')
            }
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>